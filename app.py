import streamlit as st
import base64
import os
import time

# --- C·∫§U H√åNH BAN ƒê·∫¶U ---
st.set_page_config(page_title="T·ªï B·∫£o D∆∞·ª°ng S·ªë 1", layout="wide")

# T√™n c√°c file c·∫ßn thi·∫øt
video_file = "airplane.mp4"
bg_file = "cabbase.jpg"
bg_mobile_file = "mobile.jpg" 

# === DANH S√ÅCH B√ÄI H√ÅT (Th√™m background2.mp3 ƒë·∫øn background5.mp3) ===
AUDIO_FILES = ["background.mp3", "background2.mp3", "background3.mp3", "background4.mp3", "background5.mp3"]

# ∆Ø·ªõc t√≠nh th·ªùi gian chuy·ªÉn c·∫£nh (C·∫ßn ƒëi·ªÅu ch·ªânh)
VIDEO_DURATION_SECONDS = 5  
FADE_DURATION_SECONDS = 4   
TOTAL_DELAY_SECONDS = VIDEO_DURATION_SECONDS + FADE_DURATION_SECONDS

# H√†m ƒë·ªçc file v√† chuy·ªÉn th√†nh Base64
def get_base64(file_path):
    try:
        with open(file_path, "rb") as f:
            return base64.b64encode(f.read()).decode("utf-8")
    except FileNotFoundError:
        return None

# --- Kh·ªüi t·∫°o Session State ---
if "show_main" not in st.session_state:
    st.session_state.show_main = False
if "intro_ran" not in st.session_state:
    st.session_state.intro_ran = False
# Session State M·ªöI cho Playlist
if "current_track_index" not in st.session_state:
    st.session_state.current_track_index = 0
if "is_playing" not in st.session_state:
    st.session_state.is_playing = True # M·∫∑c ƒë·ªãnh l√† ƒëang ph√°t khi trang t·∫£i

# === T·∫¢I FILE N·ªÄN S·ªöM ===
img_base64 = get_base64(bg_file)
if img_base64 is None:
    st.error(f"‚ùå Kh√¥ng t√¨m th·∫•y file {bg_file}. Vui l√≤ng ki·ªÉm tra l·∫°i t√™n v√† ƒë∆∞·ªùng d·∫´n file.")
    st.stop()
    
# T·∫¢I FILE N·ªÄN MOBILE
img_mobile_base64 = get_base64(bg_mobile_file)
if img_mobile_base64 is None:
    img_mobile_base64 = img_base64 
# ===================================================

# L·∫•y b√†i h√°t hi·ªán t·∫°i
current_track_index = st.session_state.current_track_index
current_audio_file = AUDIO_FILES[current_track_index]
audio_base64 = get_base64(current_audio_file)
current_track_name = current_audio_file
total_tracks = len(AUDIO_FILES)
is_playing_state = st.session_state.is_playing # L·∫•y tr·∫°ng th√°i ph√°t nh·∫°c


# CSS ƒë·ªông ƒë·ªÉ ki·ªÉm so√°t hi·ªÉn th·ªã video
is_main_page = st.session_state.show_main
video_display_style = "display: none;" if is_main_page else "display: flex;" 


# === CSS CHUNG V√Ä VIDEO (ƒê√£ Fix L·ªói) ===
st.markdown(f"""
<style>
/* 1. KH·∫ÆC PH·ª§C VIEWPORT TR√äN MOBILE v√† FULL HEIGHT cho PC */
html, body {{ 
    margin:0; 
    padding:0; 
    height:100%; 
    overflow:hidden; 
    background:black; 
    height: 100%; 
}}

/* 2. FULLSCREEN TRI·ªÜT ƒê·ªÇ */
header[data-testid="stHeader"], footer {{ display: none !important; }}
.block-container, section.main > div {{
    margin: 0 !important;
    padding: 0 !important;
    max-width: 100% !important;
    width: 100vw !important;
    height: 100vh !important;
}}

/* 3. CSS CHO VIDEO CONTAINER */
.video-container {{
    position: fixed; inset:0; width:100vw; height:100vh;
    justify-content:center; 
    align-items:center;
    background:black; 
    z-index:99999; 
    {video_display_style} 
    flex-direction: column; 
}}

/* Keyframes v√† animations gi·ªØ nguy√™n */
@keyframes fadeOut {{ 
    0% {{opacity:1;}}
    99% {{opacity:0.01;}}
    100%{{opacity:0; visibility:hidden; z-index:-1;}} 
}}
.intro-animation {{
    animation: fadeOut {FADE_DURATION_SECONDS}s ease-out {VIDEO_DURATION_SECONDS}s forwards; 
}}

/* 4. CSS CHO TRANG CH√çNH: BACKGROUND FIX */
.stApp {{
    background-color: #333; 
    background-image: linear-gradient(rgba(245,242,200,0.4), rgba(245,242,200,0.4)),
                      url("data:image/jpeg;base64,{img_base64}");
    
    background-attachment: fixed; 
    background-size: cover; 
    background-repeat: no-repeat;
    background-position: center center; 
    
    width: 100vw !important;
    height: 100vh !important;
    z-index:1;
}}

/* 5. MEDIA QUERY (FIX D·ª®T ƒêI·ªÇM BACKGROUND TR√äN MOBILE) */
@media screen and (max-width: 768px) {{
    .stApp {{
        background-image: linear-gradient(rgba(245,242,200,0.4), rgba(245,242,200,0.4)),
                          url("data:image/jpeg;base64,{img_mobile_base64}");
        background-size: cover; 
        background-color: #333; 
    }}
}}

/* 6. CSS M·ªöI: CUSTOM AUDIO PLAYER */
.custom-audio-player {{
    position: fixed; 
    top: 10px; 
    left: 10px; 
    z-index: 9999;
    display: flex;
    flex-direction: column;
    width: 280px; /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc ƒë·ªÉ tr√¥ng g·ªçn h∆°n */
    background: rgba(0, 0, 0, 0.7);
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}}
.player-info {{
    color: #FFF;
    font-size: 13px;
    text-align: center;
    margin-bottom: 8px;
}}
.player-controls {{
    display: flex;
    justify-content: space-around;
    align-items: center;
}}
.control-button {{
    background: none;
    border: none;
    color: #FFF;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
    transition: color 0.2s;
}}
.control-button:hover {{
    color: #4A90E2;
}}
.progress-bar {{
    height: 5px;
    background: #555;
    margin: 10px 0;
    border-radius: 2px;
    cursor: pointer;
}}
.progress-filled {{
    height: 100%;
    width: 0%; 
    background: #4A90E2;
    border-radius: 2px;
}}
.time-display {{
    display: flex;
    justify-content: space-between;
    color: #AAA;
    font-size: 11px;
}}

/* Kh√¥i ph·ª•c padding nh·∫π cho n·ªôi dung trang ch√≠nh */
.block-container {{ padding-top:2rem !important; padding-left:1rem !important; padding-right:1rem !important;}}
.main-title {{ /* Gi·ªØ nguy√™n CSS title */ }}
</style>

<script>
    // CODE JAVASCRIPT ƒê·ªÇ FIX L·ªñI 100vh TR√äN MOBILE (Gi·ªØ nguy√™n)
    function setVhProperty() {{
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${{vh}}px`);
    }}

    setVhProperty();
    window.addEventListener('resize', setVhProperty);
</script>
""", unsafe_allow_html=True)


# --- GIAO DI·ªÜN CHUY·ªÇN C·∫¢NH (VIDEO INTRO) ---
if not st.session_state.show_main and not st.session_state.intro_ran:
    
    video_data = get_base64(video_file)
    if video_data is None:
        st.error(f"‚ùå Kh√¥ng t√¨m th·∫•y file {video_file}.")
        st.stop()
    
    st.markdown(f"""
    <div class="video-container intro-animation" id="videoContainer">
        <video id="introVideo" class="video-bg" autoplay muted playsinline>
            <source src="data:video/mp4;base64,{video_data}" type="video/mp4">
        </video>
        <div class="video-text">KH√ÅM PH√Å TH·∫æ GI·ªöI C√ôNG CH√öNG T√îI</div>
    </div>
    """, unsafe_allow_html=True)
    
    time.sleep(TOTAL_DELAY_SECONDS) 
    
    st.session_state.show_main = True
    st.session_state.intro_ran = True 
    st.rerun() 
    
    st.stop() 

# --- TRANG CH√çNH ---

st.markdown('<div class="main-title">üìú T·ªî B·∫¢O D∆Ø·ª†NG S·ªê 1</div>', unsafe_allow_html=True)
st.write("Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi website ‚úàÔ∏è")

# === KH·ªêI PH√ÅT NH·∫†C T√ôY CH·ªàNH (CUSTOM AUDIO PLAYER) ===
if audio_base64:
    track_number = current_track_index + 1

    js_code = f"""
    <script>
        const AUDIO_FILES = {AUDIO_FILES};
        let currentTrackIndex = {current_track_index};
        let isPlaying = {'true' if is_playing_state else 'false'};

        // Ch·ª©c nƒÉng ƒë·ªÉ ƒë·ªãnh d·∫°ng th·ªùi gian (v√≠ d·ª•: 00:00)
        function formatTime(seconds) {{
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${{String(minutes).padStart(2, '0')}}:${{String(remainingSeconds).padStart(2, '0')}}`;
        }}

        // Ch·ª©c nƒÉng ƒë·ªÉ c·∫≠p nh·∫≠t Session State (cho tr·∫°ng th√°i Play/Pause)
        function updateStreamlitState(key, value) {{
            // Gi·∫£ l·∫≠p c·∫≠p nh·∫≠t Session State ƒë·ªÉ Streamlit bi·∫øt tr·∫°ng th√°i
            // ƒê√¢y l√† k·ªπ thu·∫≠t hack kh√¥ng ch√≠nh th·ª©c, nh∆∞ng ho·∫°t ƒë·ªông trong m√¥i tr∆∞·ªùng n√†y
            if (window.parent.document.querySelector('iframe')) {{
                window.parent.document.querySelector('iframe').contentWindow.postMessage({{
                    isStreamlit: true,
                    type: 'setComponentValue',
                    componentName: 'custom_audio_player',
                    value: {{[key]: value}}
                }}, '*');
            }}
        }}

        // Ch·ª©c nƒÉng t·∫£i v√† ph√°t b√†i h√°t
        function loadTrack() {{
            const player = document.getElementById('customAudioPlayer');
            const newTrackName = AUDIO_FILES[currentTrackIndex];
            const newTrackBase64 = '{base64.b64encode(open(newTrackName, "rb").read()).decode("utf-8")}'
            const newSrc = `data:audio/mp3;base64,${{newTrackBase64}}`;

            player.src = newSrc;
            
            // C·∫≠p nh·∫≠t th√¥ng tin b√†i h√°t
            document.getElementById('trackInfo').textContent = `Track ${{currentTrackIndex + 1}}/{total_tracks}: ${{newTrackName}}`;
            
            if (isPlaying) {{
                player.play();
                document.getElementById('playPauseButton').innerHTML = '‚è∏Ô∏è';
            }} else {{
                document.getElementById('playPauseButton').innerHTML = '‚ñ∂Ô∏è';
            }}
        }}
        
        // C·∫ßn t·∫£i l·∫°i trang khi chuy·ªÉn b√†i ƒë·ªÉ Python/Streamlit bi·∫øt b√†i h√°t m·ªõi
        function switchTrack(direction) {{
            currentTrackIndex = (currentTrackIndex + direction + {total_tracks}) % {total_tracks};
            
            // K√≠ch ho·∫°t Rerun ƒë·ªÉ t·∫£i Base64 b√†i h√°t m·ªõi t·ª´ Python
            const url = new URL(window.location);
            url.searchParams.set('track_index', currentTrackIndex);
            
            // L∆∞u tr·∫°ng th√°i Play/Pause tr∆∞·ªõc khi Rerun
            updateStreamlitState('current_track_index', currentTrackIndex); 
            updateStreamlitState('is_playing', isPlaying);

            window.location.href = url.toString(); // Rerun Streamlit
        }}


        // Ch·ª©c nƒÉng Play/Pause
        function togglePlayPause() {{
            const player = document.getElementById('customAudioPlayer');
            const button = document.getElementById('playPauseButton');

            if (player.paused) {{
                player.play();
                button.innerHTML = '‚è∏Ô∏è';
                isPlaying = true;
            }} else {{
                player.pause();
                button.innerHTML = '‚ñ∂Ô∏è';
                isPlaying = false;
            }}
            updateStreamlitState('is_playing', isPlaying); // L∆∞u tr·∫°ng th√°i
        }}

        // ƒê·ªìng b·ªô thanh ti·∫øn tr√¨nh v√† th·ªùi gian
        document.addEventListener('DOMContentLoaded', () => {{
            const player = document.getElementById('customAudioPlayer');
            const progressBar = document.getElementById('progressBar');
            const progressFilled = document.getElementById('progressFilled');
            const currentTimeDisplay = document.getElementById('currentTime');
            const durationTimeDisplay = document.getElementById('durationTime');

            // Set tr·∫°ng th√°i ban ƒë·∫ßu
            if (isPlaying) {{ player.play(); }} else {{ player.pause(); }}

            // S·ª± ki·ªán c·∫≠p nh·∫≠t th·ªùi gian
            player.addEventListener('timeupdate', () => {{
                if (player.duration) {{
                    const percentage = (player.currentTime / player.duration) * 100;
                    progressFilled.style.width = percentage + '%';
                    currentTimeDisplay.textContent = formatTime(player.currentTime);
                }}
            }});
            
            // S·ª± ki·ªán khi metadata ƒë∆∞·ª£c t·∫£i
            player.addEventListener('loadedmetadata', () => {{
                durationTimeDisplay.textContent = formatTime(player.duration);
            }});

            // S·ª± ki·ªán khi b√†i h√°t k·∫øt th√∫c (T·ª± ƒë·ªông chuy·ªÉn b√†i)
            player.addEventListener('ended', () => {{
                switchTrack(1);
            }});

            // X·ª≠ l√Ω click thanh ti·∫øn tr√¨nh
            progressBar.addEventListener('click', (e) => {{
                const clickPosition = e.offsetX;
                const totalWidth = progressBar.offsetWidth;
                const clickRatio = clickPosition / totalWidth;
                
                if (player.duration) {{
                    player.currentTime = player.duration * clickRatio;
                }}
            }});
            
            // Fix cho v·∫•n ƒë·ªÅ Autoplay (Chromium)
            player.play().catch(error => {{
                // Autoplay b·ªã ch·∫∑n, hi·ªÉn th·ªã n√∫t Play
                document.getElementById('playPauseButton').innerHTML = '‚ñ∂Ô∏è';
                isPlaying = false;
                player.pause();
            }});
        }});
    </script>
    """
    
    # ƒê·∫∑t n·ªôi dung HTML/JS v√†o placeholder
    st.markdown(f"""
    <div style="display: none;">
        <audio id="customAudioPlayer" src="data:audio/mp3;base64,{audio_base64}" loop></audio>
    </div>
    <div class="custom-audio-player">
        <div class="player-info" id="trackInfo">Track {track_number}/{total_tracks}: {current_track_name}</div>
        <div class="progress-bar" id="progressBar">
            <div class="progress-filled" id="progressFilled"></div>
        </div>
        <div class="time-display">
            <span id="currentTime">00:00</span>
            <span id="durationTime">--:--</span>
        </div>
        <div class="player-controls">
            <button class="control-button" onclick="switchTrack(-1)">‚èÆÔ∏è</button>
            <button class="control-button" id="playPauseButton" onclick="togglePlayPause()">
                {'‚è∏Ô∏è' if is_playing_state else '‚ñ∂Ô∏è'}
            </button>
            <button class="control-button" onclick="switchTrack(1)">‚è≠Ô∏è</button>
        </div>
    </div>
    {js_code}
    """, unsafe_allow_html=True)
# =================================================================================
