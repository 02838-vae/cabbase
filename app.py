import streamlit as st
import base64
import os

# --- C·∫§U H√åNH BAN ƒê·∫¶U ---
st.set_page_config(page_title="T·ªï B·∫£o D∆∞·ª°ng S·ªë 1", layout="wide")

# T√™n c√°c file c·∫ßn thi·∫øt
video_file = "airplane.mp4"
bg_file = "cabbase.jpg"
audio_file = "background.mp3"

# ∆Ø·ªõc t√≠nh th·ªùi gian chuy·ªÉn c·∫£nh (C·∫ßn ƒëi·ªÅu ch·ªânh)
VIDEO_DURATION_SECONDS = 5
FADE_DURATION_SECONDS = 4
TOTAL_DELAY_SECONDS = VIDEO_DURATION_SECONDS + FADE_DURATION_SECONDS

# H√†m ƒë·ªçc file v√† chuy·ªÉn th√†nh Base64
def get_base64(file_path):
    try:
        with open(file_path, "rb") as f:
            return base64.b64encode(f.read()).decode("utf-8")
    except FileNotFoundError:
        return None

# H√†m callback khi k√≠ch ho·∫°t chuy·ªÉn c·∫£nh
def switch_to_main():
    # Khi n√∫t v√¥ h√¨nh ƒë∆∞·ª£c nh·∫•n, thay ƒë·ªïi c·ªù
    st.session_state.show_main = True
    # Kh√¥ng c·∫ßn st.rerun() ·ªü ƒë√¢y, v√¨ vi·ªác nh·∫•n n√∫t ƒë√£ k√≠ch ho·∫°t Streamlit rerun

# Kh·ªüi t·∫°o Session State
if "show_main" not in st.session_state:
    st.session_state.show_main = False

# --- GIAO DI·ªÜN CHUY·ªÇN C·∫¢NH (VIDEO INTRO) ---
if not st.session_state.show_main:
    
    video_data = get_base64(video_file)
    if video_data is None:
        st.error(f"‚ùå Kh√¥ng t√¨m th·∫•y file {video_file}. Vui l√≤ng ki·ªÉm tra l·∫°i t√™n v√† ƒë∆∞·ªùng d·∫´n file.")
        st.stop()
    
    # === KH·∫ÆC PH·ª§C 1: ·∫®N N√öT NGAY L·∫¨P T·ª®C ===
    # 1. Th√™m CSS ƒë·ªÉ ·∫©n t·∫•t c·∫£ c√°c n√∫t c√≥ key n√†y ngay t·ª´ ƒë·∫ßu
    st.markdown(f"""
    <style>
    /* ·∫®n tri·ªát ƒë·ªÉ n√∫t V√¥ h√¨nh tr∆∞·ªõc khi video ch·∫°y */
    [data-testid="stButton"] button[key="switch_trigger_button"] {{
        visibility: hidden !important;
        height: 0 !important;
        width: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        opacity: 0 !important;
        display: none !important; 
    }}

    /* CSS cho trang video */
    html, body {{ margin:0; padding:0; height:100%; overflow:hidden; background:black; }}
    .video-container {{
        position: fixed; inset:0; width:100%; height:100%;
        display:flex; justify-content:center; align-items:center;
        background:black; z-index:9999;
        animation: fadeOut {FADE_DURATION_SECONDS}s ease-out {VIDEO_DURATION_SECONDS}s forwards; 
    }}
    .video-bg {{ width:100%; height:100%; object-fit:cover; }}
    
    /* Hi·ªáu ·ª©ng m·ªù d·∫ßn */
    @keyframes fadeOut {{
        0% {{opacity:1; visibility:visible;}}
        99% {{opacity:0.01; visibility:visible;}}
        100%{{opacity:0; visibility:hidden;}}
    }}
    
    /* Gi·ªØ nguy√™n c√°c animation kh√°c */
    .video-text {{
        position:absolute; bottom:12vh; width:100%; text-align:center;
        font-family:'Special Elite', cursive; font-size:clamp(24px,5vw,44px);
        font-weight:bold; color:#fff;
        text-shadow: 0 0 20px rgba(255,255,255,0.8), 0 0 40px rgba(180,220,255,0.6), 0 0 60px rgba(255,255,255,0.4);
        opacity:0;
        animation: appear 3s ease-in forwards, floatFade 3s ease-in 5s forwards;
    }}
    @keyframes appear {{ 0% {{opacity:0; filter:blur(8px); transform:translateY(40px);}} 100%{{opacity:1; filter:blur(0); transform:translateY(0);}} }}
    @keyframes floatFade {{ 0% {{opacity:1; filter:blur(0); transform:translateY(0);}} 100%{{opacity:0; filter:blur(12px); transform:translateY(-30px) scale(1.05);}} }}
    </style>
    """, unsafe_allow_html=True)
    
    # 2. ƒê·∫∑t n√∫t V√¥ h√¨nh sau CSS, nh∆∞ng n√≥ ph·∫£i ƒë∆∞·ª£c render.
    # N√∫t ƒë∆∞·ª£c ƒë·∫∑t ·ªü ƒë√¢y v√† b·ªã ·∫©n b·∫±ng CSS ph√≠a tr√™n.
    st.button("V√¥ h√¨nh", key="switch_trigger_button", on_click=switch_to_main)
             
    st.markdown(f"""
    <div class="video-container" id="videoContainer">
        <video id="introVideo" class="video-bg" autoplay muted playsinline>
            <source src="data:video/mp4;base64,{video_data}" type="video/mp4">
        </video>
        <div class="video-text">KH√ÅM PH√Å TH·∫æ GI·ªöI C√ôNG CH√öNG T√îI</div>
    </div>
    
    <script>
        // === KH·∫ÆC PH·ª§C 2: T·ª∞ ƒê·ªòNG CHUY·ªÇN C·∫¢NH ===
        // ƒê·∫∑t h·∫πn gi·ªù ƒë·ªÉ k√≠ch ho·∫°t n√∫t v√¥ h√¨nh sau khi video v√† fade k·∫øt th√∫c
        setTimeout(() => {{
            // T√¨m n√∫t v√¥ h√¨nh b·∫±ng thu·ªôc t√≠nh 'key' trong DOM (ƒê·∫£m b·∫£o ƒë·ªô ch√≠nh x√°c)
            const switchButton = window.parent.document.querySelector('[data-testid="stButton"] button[key="switch_trigger_button"]');
            
            if (switchButton) {{
                // K√≠ch ho·∫°t callback switch_to_main()
                switchButton.click(); 
                
                // Lo·∫°i b·ªè container video (M·∫∑c d√π CSS ƒë√£ l√†m, nh∆∞ng ƒë·∫£m b·∫£o)
                const container = document.getElementById('videoContainer');
                if (container) {{
                    container.style.display='none';
                }}
            }} else {{
                // Fallback: N·∫øu kh√¥ng t√¨m th·∫•y n√∫t, in ra console ƒë·ªÉ debug (n·∫øu b·∫°n ch·∫°y console)
                console.error("L·ªói: Kh√¥ng t√¨m th·∫•y n√∫t k√≠ch ho·∫°t Streamlit.");
            }}
        }}, {TOTAL_DELAY_SECONDS * 1000});
    </script>
    """, unsafe_allow_html=True)
    
    st.stop() # D·ª´ng lu·ªìng cho ƒë·∫øn khi n√∫t v√¥ h√¨nh ƒë∆∞·ª£c k√≠ch ho·∫°t

# --- TRANG CH√çNH ---
# ... (Ph·∫ßn code hi·ªÉn th·ªã trang ch√≠nh c·ªßa b·∫°n gi·ªØ nguy√™n) ...
# B·∫°n kh√¥ng c·∫ßn ph·∫£i thay ƒë·ªïi g√¨ trong ph·∫ßn n√†y.
# Code ·ªü ƒë√¢y s·∫Ω t·ª± ƒë·ªông ch·∫°y sau khi switch_to_main ƒë∆∞·ª£c g·ªçi v√† Streamlit rerun.
img_base64 = get_base64(bg_file)
if img_base64 is None:
    st.error(f"‚ùå Kh√¥ng t√¨m th·∫•y file {bg_file}.")
    st.stop()

st.markdown(f"""
<style>
.stApp {{
    background: linear-gradient(rgba(245,242,200,0.4), rgba(245,242,200,0.4)),
                url("data:image/jpeg;base64,{img_base64}") no-repeat center center fixed;
    background-size: cover;
}}
header[data-testid="stHeader"] {{ display:none; }}
.block-container {{ padding-top:2rem; }}
.main-title {{
    font-family:'Special Elite', cursive;
    font-size: clamp(36px,5vw,48px);
    font-weight:bold; text-align:center;
    color:#3e2723; margin-top:50px;
    text-shadow:2px 2px 0 #fff,0 0 25px #f0d49b,0 0 50px #bca27a;
}}
</style>
""", unsafe_allow_html=True)

audio_base64 = get_base64(audio_file)
if audio_base64:
    st.markdown(f"""
    <audio autoplay loop controls style="position:fixed; top:10px; left:10px; width:200px; z-index:9999;">
        <source src="data:audio/mp3;base64,{audio_base64}" type="audio/mp3">
    </audio>
    """, unsafe_allow_html=True)

st.markdown('<div class="main-title">üìú T·ªî B·∫¢O D∆Ø·ª†NG S·ªê 1</div>', unsafe_allow_html=True)
st.write("Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi website ‚úàÔ∏è")
