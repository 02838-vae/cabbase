import streamlit as st
import random
import time

# --- C·∫•u h√¨nh Trang (Lu√¥n ƒë·∫∑t ·ªü ƒë·∫ßu) ---
st.set_page_config(layout="wide", page_title="T·ªï B·∫£o D∆∞·ª°ng S·ªë 1")

# --- Kh·ªüi t·∫°o Session State ---
if 'intro_complete' not in st.session_state:
    st.session_state['intro_complete'] = False

# --- Kh·∫Øc ph·ª•c: CSS T√πy ch·ªânh & JavaScript ƒë·ªÉ Chuy·ªÉn Trang M∆∞·ª£t m√† ---

def custom_css_js():
    """CSS v√† JS ƒë·ªÉ x·ª≠ l√Ω hi·ªáu ·ª©ng video v√† chuy·ªÉn trang"""
    # Ch·ªçn ·∫£nh n·ªÅn d·ª±a tr√™n gi·∫£ ƒë·ªãnh thi·∫øt b·ªã (d√πng Media Query trong CSS)
    
    # CSS cho n·ªÅn v√† font ch·ªØ Vintage
    vintage_css = f"""
    <style>
    /* CSS Chung cho Trang Ch√≠nh */
    .main-page-bg {{
        background-image: url("cabbage.jpg"); /* ·∫¢nh n·ªÅn PC/Default */
    }}
    
    /* Media Query cho Mobile */
    @media only screen and (max-width: 768px) {{
        .main-page-bg {{
            background-image: url("mobile.jpg"); /* ·∫¢nh n·ªÅn Mobile */
        }}
    }}

    .stApp {{
        /* √Åp d·ª•ng n·ªÅn cho c·∫£ app */
        background-size: cover;
        background-attachment: fixed;
        background-position: center;
    }}

    /* Th√™m class cho Trang Ch√≠nh ƒë·ªÉ nh·∫≠n n·ªÅn */
    .reportview-container .main .block-container {{
        padding-top: 0rem;
        padding-bottom: 0rem;
    }}
    
    /* Thi·∫øt l·∫≠p font ch·ªØ ki·ªÉu c·ªï ƒëi·ªÉn */
    h1, .stText, p, .stMarkdown, label {{
        font-family: 'Times New Roman', serif; /* Font c·ªï ƒëi·ªÉn */
        color: #5D4037; /* M√†u n√¢u ƒë·∫≠m, c·ªï k√≠nh */
    }}
    
    /* Hi·ªáu ·ª©ng ch·ªØ Intro */
    @keyframes fade_in_out {{
        0% {{ opacity: 0; }}
        10% {{ opacity: 1; }} /* Xu·∫•t hi·ªán nhanh h∆°n */
        90% {{ opacity: 1; }}
        100% {{ opacity: 0; }} /* Bi·∫øn m·∫•t ·ªü cu·ªëi video */
    }}
    
    #intro-text {{
        position: fixed; /* D√πng fixed ƒë·ªÉ lu√¥n n·∫±m tr√™n c√πng */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3em;
        color: white;
        text-shadow: 2px 2px 4px #000000;
        animation: fade_in_out 4s forwards; 
        z-index: 10000; /* ƒê·∫£m b·∫£o n·∫±m tr√™n m·ªçi th·ª© */
        pointer-events: none;
    }}
    
    /* Hi·ªáu ·ª©ng chuy·ªÉn c·∫£nh video m·ªù d·∫ßn */
    @keyframes video_fade_out {{
        0% {{ opacity: 1; }}
        100% {{ opacity: 0; }}
    }}
    
    #intro-video-container {{
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        background-color: black;
        opacity: 1;
        transition: opacity 1s ease-out; /* Hi·ªáu ·ª©ng m·ªù 1s */
    }}
    
    #intro-video-container.fade-out {{
        animation: video_fade_out 1s forwards; /* T√™n hi·ªáu ·ª©ng */
        animation-delay: 4s; /* B·∫Øt ƒë·∫ßu m·ªù sau 4s (t·ªïng video 5s) */
    }}

    </style>
    """
    st.markdown(vintage_css, unsafe_allow_html=True)

    # JavaScript ƒë·ªÉ k√≠ch ho·∫°t video v√† l·∫Øng nghe s·ª± ki·ªán k·∫øt th√∫c
    js_script = """
    <script>
    const video = document.getElementById('intro-video');
    const container = document.getElementById('intro-video-container');
    
    // Kh·ªüi ch·∫°y video v√† th√™m hi·ªáu ·ª©ng chuy·ªÉn c·∫£nh
    if (video) {
        // Th·ª≠ ch·∫°y video
        video.play().catch(error => {
            console.log("Autoplay prevented:", error);
            // C√≥ th·ªÉ hi·ªán n√∫t "B·∫Øt ƒë·∫ßu" n·∫øu c·∫ßn thi·∫øt
        });

        // Th√™m class 'fade-out' ƒë·ªÉ k√≠ch ho·∫°t hi·ªáu ·ª©ng m·ªù sau 4s
        setTimeout(() => {
            if (container) {
                container.classList.add('fade-out');
            }
        }, 4000); // 4 gi√¢y tr∆∞·ªõc khi m·ªù
        
        // L·∫Øng nghe s·ª± ki·ªán video k·∫øt th√∫c sau 5s
        setTimeout(() => {
            // G·ª≠i m·ªôt th√¥ng ƒëi·ªáp (chuy·ªÉn tr·∫°ng th√°i) v·ªÅ Streamlit
            window.parent.document.dispatchEvent(new CustomEvent('streamlit:setSessionState', {
                detail: {key: 'intro_complete', value: true}
            }));
            // B·ªè container video ra kh·ªèi DOM sau khi m·ªù xong
            if (container) {
                container.remove();
            }
        }, 5000); // 5 gi√¢y sau ƒë√≥
    }
    </script>
    """
    st.components.v1.html(js_script, height=0, width=0) # Nh√∫ng JS v√†o Streamlit

# --- ƒê·ªãnh nghƒ©a c√°c M√†n h√¨nh ---

def intro_screen():
    """M√†n h√¨nh Intro v·ªõi Video v√† Ch·ªØ (S·ª≠ d·ª•ng components.v1.html)"""
    st.empty() # X√≥a h·∫øt n·ªôi dung c≈©
    custom_css_js() # Nh√∫ng CSS/JS c·∫ßn thi·∫øt

    # HTML/Video cho m√†n h√¨nh Intro
    video_html = """
    <div id="intro-video-container">
        <video id="intro-video" width="100%" height="100%" autoplay muted playsinline style="object-fit: cover;">
            <source src="airplane.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    <div id="intro-text">KH√ÅM PH√Å TH·∫æ GI·ªöI C√ôNG CH√öNG T√îI</div>
    """
    # st.components.v1.html l√† c√°ch t·ªët nh·∫•t ƒë·ªÉ nh√∫ng HTML/Video/JS t√πy ch·ªânh
    st.components.v1.html(video_html, height=700, scrolling=False)


def main_page():
    """Trang Ch√≠nh T·ªëi Gi·∫£n theo phong c√°ch Vintage"""
    
    # √Åp d·ª•ng CSS Vintage v√† n·ªÅn
    st.markdown('<div class="stApp main-page-bg">', unsafe_allow_html=True)
    custom_css_js() 

    # 1. Thanh ph√°t nh·∫°c ng·∫´u nhi√™n (G√≥c tr√™n b√™n tr√°i)
    music_files = [f"background{i}.mp3" for i in range(6)] # background.mp3 ƒë·∫øn background5.mp3
    random_track = random.choice(music_files)
    
    # S·ª≠ d·ª•ng st.sidebar ƒë·ªÉ ƒë·∫∑t thanh nh·∫°c g√≥c tr√™n b√™n tr√°i
    with st.sidebar:
        st.subheader("üé∂ Nh·∫°c N·ªÅn C·ªï ƒêi·ªÉn")
        # D√πng st.audio ƒë·ªÉ ph√°t nh·∫°c
        st.audio(random_track, format="audio/mp3", start_time=0, loop=True) # loop=True ƒë·ªÉ ph√°t l·∫°i ng·∫´u nhi√™n
        st.caption(f"ƒêang ph√°t ng·∫´u nhi√™n: **{random_track}**")
        st.markdown(
            """
            <style>
            /* ƒê·ªãnh d·∫°ng l·∫°i st.audio trong sidebar cho phong c√°ch Vintage */
            [data-testid="stSidebarContent"] {{
                background-color: rgba(255, 255, 240, 0.7); /* N·ªÅn sidebar m√†u ng√† */
                padding: 15px;
            }}
            .stAudio {{
                background-color: rgba(245, 245, 220, 0.8);
                border: 1px solid #A1887F;
                border-radius: 10px;
                padding: 5px;
            }}
            </style>
            """, unsafe_allow_html=True
        )

    # 2. Ti√™u ƒë·ªÅ canh gi·ªØa
    st.markdown("<h1 style='text-align: center; color: #4E342E; font-size: 3.5em; text-shadow: 1px 1px 2px #FFF8DC;'>T·ªî B·∫¢O D∆Ø·ª†NG S·ªê 1</h1>", unsafe_allow_html=True)
    
    # 3. N·ªôi dung r·ªóng (ƒë√£ x√≥a c√°c ƒëo·∫°n text y√™u c·∫ßu)
    st.empty() 

    st.markdown('</div>', unsafe_allow_html=True) # K·∫øt th√∫c div .main-page-bg


# --- Lu·ªìng ·ª®ng D·ª•ng Ch√≠nh ---
if st.session_state['intro_complete']:
    main_page()
else:
    intro_screen()

# --- X·ª≠ l√Ω s·ª± ki·ªán sau khi JS chuy·ªÉn tr·∫°ng th√°i ---
# V√¨ JS kh√¥ng th·ªÉ t·ª± ƒë·ªông g·ªçi st.rerun(), ta th√™m m·ªôt button ·∫©n ƒë·ªÉ bu·ªôc Streamlit c·∫≠p nh·∫≠t
if st.session_state['intro_complete'] and st.button('Click to start', key='hidden_start_btn'):
    st.rerun()
# Note: D√π c√≥ st.rerun() hay kh√¥ng, Streamlit s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t session state khi c√≥ t∆∞∆°ng t√°c
# ho·∫∑c khi JS g·ª≠i l·ªánh. T√πy thu·ªôc v√†o m√¥i tr∆∞·ªùng, b·∫°n c√≥ th·ªÉ th·∫•y trang ch√≠nh xu·∫•t hi·ªán ngay
# sau 5s ho·∫∑c c·∫ßn m·ªôt t∆∞∆°ng t√°c nh·ªè.
