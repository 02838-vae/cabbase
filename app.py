import streamlit as st
import base64

# --- H√ÄM H·ªñ TR·ª¢ ---
def get_base64_encoded_file(file_path):
    """M√£ h√≥a file th√†nh chu·ªói base64."""
    try:
        with open(file_path, "rb") as f:
            data = f.read()
        return base64.b64encode(data).decode("utf-8")
    except FileNotFoundError:
        return "" 

# --- C·∫§U H√åNH V√Ä M√É H√ìA MEDIA ---

# C·∫•u h√¨nh trang (T·∫Øt menu m·∫∑c ƒë·ªãnh)
st.set_page_config(
    page_title="Kh√°m ph√° c√πng ch√∫ng t√¥i",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# M√£ h√≥a c√°c file media v√† h√¨nh n·ªÅn
try:
    video_pc_base64 = get_base64_encoded_file("airplane.mp4")
    video_mobile_base64 = get_base64_encoded_file("mobile.mp4")
    audio_base64 = get_base64_encoded_file("plane_fly.mp3")
    
    # M√£ h√≥a h√¨nh n·ªÅn
    cabbage_base64 = get_base64_encoded_file("cabbase.jpg")
    mobile_bg_base64 = get_base64_encoded_file("mobile.jpg")
    
    # Ki·ªÉm tra xem c√≥ ƒë·ªß file c·∫ßn thi·∫øt kh√¥ng
    if not (video_pc_base64 and video_mobile_base64 and audio_base64 and cabbage_base64 and mobile_bg_base64):
        missing_files = []
        if not video_pc_base64: missing_files.append("airplane.mp4")
        if not video_mobile_base64: missing_files.append("mobile.mp4")
        if not audio_base64: missing_files.append("plane_fly.mp3")
        if not cabbage_base64: missing_files.append("cabbase.jpg")
        if not mobile_bg_base64: missing_files.append("mobile.jpg")
        st.error(f"L·ªói: Kh√¥ng t√¨m th·∫•y (ho·∫∑c file r·ªóng) c√°c file sau: {', '.join(missing_files)}. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng d·∫´n.")
        st.stop()
        
except Exception as e:
    st.error(f"L·ªói h·ªá th·ªëng khi ƒë·ªçc file: {e}")
    st.stop()


# --- CSS CHUNG CHO STREAMLIT (NH√öNG ·∫¢NH N·ªÄN V√Ä HI·ªÜU ·ª®NG CHUY·ªÇN TRANG) ---

# S·ª¨ D·ª§NG F-STRING ƒê·ªÇ NH√öNG BASE64 C·ª¶A ·∫¢NH N·ªÄN V√ÄO CSS
hide_streamlit_style = f"""
<style>
/* ·∫®n c√°c th√†nh ph·∫ßn m·∫∑c ƒë·ªãnh c·ªßa Streamlit */
#MainMenu {{visibility: hidden;}}
footer {{visibility: hidden;}}
header {{visibility: hidden;}}

/* ƒê·∫£m b·∫£o Main Content Container chi·∫øm to√†n b·ªô kh√¥ng gian */
.main {{
    padding: 0;
    margin: 0;
    background-color: transparent;
    transition: opacity 1s ease-in; /* Transition cho n·ªôi dung ch√≠nh */
}}

/* ƒê·∫£m b·∫£o khu v·ª±c n·ªôi dung ƒë∆∞·ª£c cƒÉn ch·ªânh s√°t l·ªÅ */
div.block-container {{
    padding: 0;
    margin: 0;
    max-width: 100% !important;
}}

/* √âp iframe c·ªßa component chi·∫øm to√†n b·ªô chi·ªÅu cao/r·ªông */
iframe {{
    width: 100vw !important;
    height: 100vh !important;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000; /* ƒê·∫£m b·∫£o n√≥ che ph·ªß m·ªçi th·ª© */
}}

/* Class ƒë·ªÉ ·∫©n l·ªõp ph·ªß video sau khi chuy·ªÉn ti·∫øp */
.stApp.fade-out-overlay > iframe {{
    visibility: hidden; 
    opacity: 0;
    transition: visibility 0s 1.5s, opacity 1.5s ease-in-out; 
}}

/* Class ƒë·ªÉ l√†m hi·ªán n·ªôi dung ch√≠nh c·ªßa trang */
.stApp.fade-out-overlay .main {{
    opacity: 1; /* Hi·ªÉn th·ªã n·ªôi dung ch√≠nh */
}}

/* ·∫®n n·ªôi dung ch√≠nh ban ƒë·∫ßu */
.stApp .main {{
    opacity: 0;
}}


/* --- CSS CHO N·ªòI DUNG CH√çNH (N·ªÄN C·ªê ƒê·ªäNH) --- */
.stApp {{
    /* ƒê·∫∑t n·ªÅn m·∫∑c ƒë·ªãnh cho PC */
    background-image: url('data:image/jpeg;base64,{cabbage_base64}') !important; 
    background-size: cover !important;
    background-position: center center !important;
    background-attachment: fixed !important; /* Quan tr·ªçng */
}}

@media (max-width: 768px) {{
    .stApp {{
        /* Thay th·∫ø n·ªÅn cho Mobile */
        background-image: url('data:image/jpeg;base64,{mobile_bg_base64}') !important;
    }}
}}

</style>
"""
# √Åp d·ª•ng CSS cho trang Streamlit ch√≠nh
st.markdown(hide_streamlit_style, unsafe_allow_html=True)


# --- M√É HTML/CSS/JavaScript CHO VIDEO INTRO (TRONG IFRAME) ---

html_content = f"""
<!DOCTYPE html>
<html>
<head>
    <style>
        /* CSS TRONG IFRAME */
        html, body {{
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw;
            background: black;
        }}
        
        /* CSS cho video fullscreen */
        #intro-video {{
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -100;
            transition: transform 1.5s cubic-bezier(0.5, 0.0, 0.5, 1.0), opacity 1.5s ease-out;
        }}
        
        /* Hi·ªáu ·ª©ng ph√≥ng to v√† l√†m m·ªù */
        #intro-video.fadeout {{
            transform: scale(1.1);
            opacity: 0;
        }}

        /* CSS cho d√≤ng ch·ªØ c·ªë ƒë·ªãnh */
        #intro-text {{
            position: fixed;
            top: 5vh; 
            width: 100%;
            text-align: center;
            color: white; 
            font-size: 3vw; 
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); 
            z-index: 100; 
            pointer-events: none;
            opacity: 0; 
            transition: opacity 1s; 
        }}
        
        @media (max-width: 768px) {{
            #intro-text {{
                font-size: 8vw;
            }}
        }}

        /* --- CSS M·ªöI: N√öT B·∫ÆT ƒê·∫¶U --- */
        #start-button {{
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000; 
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }}
        #start-button.hidden {{
            opacity: 0;
            pointer-events: none;
        }}
        #start-button h1 {{
            font-size: 5vw;
            margin-bottom: 20px;
        }}
        #start-button button {{
            padding: 15px 30px;
            font-size: 1.5vw;
            background-color: #33aaff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }}
        #start-button button:hover {{
            background-color: #0077cc;
        }}
        @media (max-width: 768px) {{
            #start-button h1 {{ font-size: 10vw; }}
            #start-button button {{ font-size: 4vw; }}
        }}
        
    </style>
</head>
<body>

    <div id="intro-text">KH√ÅM PH√Å TH·∫æ GI·ªöI C√ôNG CH√öNG T√îI</div>
    
    <video id="intro-video" muted playsinline></video>
    
    <audio id="background-audio"></audio>

    <div id="start-button">
        <h1>S·∫µn s√†ng Kh√°m ph√°?</h1>
        <button id="start-media">B·∫ÆT ƒê·∫¶U</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {{
            const video = document.getElementById('intro-video');
            const audio = document.getElementById('background-audio');
            const introText = document.getElementById('intro-text');
            const startButton = document.getElementById('start-button');
            const startMediaButton = document.getElementById('start-media');
            const isMobile = window.innerWidth <= 768;

            // Thi·∫øt l·∫≠p ngu·ªìn video/audio
            if (isMobile) {{
                video.src = 'data:video/mp4;base64,{video_mobile_base64}';
            }} else {{
                video.src = 'data:video/mp4;base64,{video_pc_base64}';
            }}
            audio.src = 'data:audio/mp3;base64,{audio_base64}';
            
            // --- LOGIC M·ªöI: CH·ªú CLICK T·ª™ NG∆Ø·ªúI D√ôNG ---
            startMediaButton.addEventListener('click', () => {{
                // T∆∞∆°ng t√°c ng∆∞·ªùi d√πng ƒë√£ x·∫£y ra, gi·ªù c√≥ th·ªÉ play
                video.load();
                video.play().then(() => {{
                    // Video ƒëang ch·∫°y
                    startButton.classList.add('hidden');
                    setTimeout(() => {{ introText.style.opacity = 1; }}, 500);
                    
                    audio.volume = 0.5;
                    audio.play().catch(e => console.error("Audio playback failed after user interaction:", e));

                }}).catch(e => {{
                    console.error("Video playback failed after user click:", e);
                    startButton.classList.add('hidden');
                    setTimeout(() => {{ introText.style.opacity = 1; }}, 500);
                }});
            }}, {{ once: true }});

            // --- LOGIC CHUY·ªÇN TRANG KHI VIDEO K·∫æT TH√öC ---
            video.onended = () => {{
                // 1. √Åp d·ª•ng hi·ªáu ·ª©ng ph√≥ng to/m·ªù cho video
                video.classList.add('fadeout');
                
                // 2. T·∫Øt nh·∫°c
                audio.pause(); 
                audio.currentTime = 0; 
                introText.style.opacity = 0;
                
                // 3. K√≠ch ho·∫°t chuy·ªÉn trang ch√≠nh trong Streamlit parent window
                parent.document.querySelector('.stApp').classList.add('fade-out-overlay');
            }};
        }});
    </script>
</body>
</html>
"""

# Hi·ªÉn th·ªã th√†nh ph·∫ßn HTML
st.components.v1.html(html_content, height=10, scrolling=False)


# --- N·ªòI DUNG CH√çNH C·ª¶A TRANG (HI·ªÜN RA SAU HI·ªÜU ·ª®NG) ---
st.markdown("""
<div style="
    padding: 20px; 
    margin-top: 100vh; /* ƒê·∫©y n·ªôi dung xu·ªëng d∆∞·ªõi l·ªõp video overlay */
    background-color: rgba(255, 255, 255, 0.8); /* N·ªÅn h∆°i trong su·ªët ƒë·ªÉ nh√¨n th·∫•y ·∫£nh n·ªÅn c·ªë ƒë·ªãnh */
    position: relative; 
    z-index: 10;
    min-height: 100vh; /* ƒê·∫£m b·∫£o trang ch√≠nh c√≥ chi·ªÅu cao t·ªëi thi·ªÉu */
">
    <h1 style="color: black;">üëã Ch√†o m·ª´ng ƒë·∫øn v·ªõi Trang Ch√≠nh!</h1>
    <p style="color: black;">Hi·ªáu ·ª©ng chuy·ªÉn trang m∆∞·ª£t m√† ƒë√£ ho√†n t·∫•t.</p>
    <p style="color: black;">ƒê√¢y l√† n·ªôi dung ch√≠nh c·ªßa trang web. ·∫¢nh n·ªÅn l√† **cabbase.jpg** (ho·∫∑c mobile.jpg) c·ªë ƒë·ªãnh.</p>
    
    <div style="
        margin: 50px 0;
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        height: 800px; 
        display: flex;
        align-items: center;
        justify-content: center;
    ">
        <h3 style="color: black;">Cu·ªôn xu·ªëng ƒë·ªÉ xem th√™m</h3>
    </div>
    
    <p style="color: black; text-align: center;">--- H·∫æT N·ªòI DUNG ---</p>
</div>
""", unsafe_allow_html=True)
