import streamlit as st
import base64
from pathlib import Path
import time

st.set_page_config(page_title="Airplane Intro", layout="wide", initial_sidebar_state="collapsed")

# ·∫®n ho√†n to√†n sidebar & header c·ªßa Streamlit
hide_streamlit_style = """
    <style>
    [data-testid="stSidebar"], [data-testid="stToolbar"], header {display: none !important;}
    #MainMenu, footer {visibility: hidden;}
    </style>
"""
st.markdown(hide_streamlit_style, unsafe_allow_html=True)

# Qu·∫£n l√Ω tr·∫°ng th√°i
if "intro_done" not in st.session_state:
    st.session_state.intro_done = False

# ---------- PH·∫¶N INTRO ----------
if not st.session_state.intro_done:
    video_path = Path("airplane.mp4")
    if not video_path.exists():
        st.error("‚ùå Kh√¥ng t√¨m th·∫•y file airplane.mp4 trong th∆∞ m·ª•c hi·ªán t·∫°i!")
        st.stop()

    # Encode video sang base64
    video_bytes = video_path.read_bytes()
    video_base64 = base64.b64encode(video_bytes).decode("utf-8")

    # HTML + CSS
    st.markdown(f"""
    <style>
    html, body, [class*="stAppViewContainer"], [class*="stMainBlockContainer"], [class*="stApp"] {{
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: black;
    }}
    video {{
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        z-index: -1;
    }}
    .overlay-text {{
        position: fixed;
        bottom: 10%;
        width: 100%;
        text-align: center;
        font-size: 2rem;
        font-weight: bold;
        color: white;
        text-shadow: 2px 2px 10px black;
        opacity: 0;
        animation: fadeInOut 5s ease-in-out forwards;
        animation-delay: 1s;
    }}
    @keyframes fadeInOut {{
        0% {{opacity: 0;}}
        20% {{opacity: 1;}}
        80% {{opacity: 1;}}
        100% {{opacity: 0;}}
    }}
    </style>

    <video id="introVideo" autoplay muted playsinline>
        <source src="data:video/mp4;base64,{video_base64}" type="video/mp4">
    </video>
    <div class="overlay-text">KH√ÅM PH√Å TH·∫æ GI·ªöI C√ôNG CH√öNG T√îI</div>

    <script>
    // Khi video k·∫øt th√∫c ‚Üí g·ª≠i t√≠n hi·ªáu sang Python
    const video = document.getElementById("introVideo");
    video.onended = () => {{
        fetch("/_stcore/stream", {{method:"POST"}}).then(() => window.location.reload());
    }};
    </script>
    """, unsafe_allow_html=True)

    st.stop()

# ---------- TRANG CH√çNH ----------
st.session_state.intro_done = True

st.markdown(
    f"""
    <style>
    .stApp {{
        background: url("cabbase.jpg") no-repeat center center fixed;
        background-size: cover;
    }}
    .main-box {{
        background-color: rgba(255, 255, 255, 0.8);
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        max-width: 900px;
        margin: 5rem auto;
    }}
    </style>
    """,
    unsafe_allow_html=True
)

st.markdown("<div class='main-box'>", unsafe_allow_html=True)
st.title("üåç Trang Ch√≠nh")
st.write("Video intro ƒë√£ k·∫øt th√∫c. Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi trang web!")
st.markdown("</div>", unsafe_allow_html=True)
