import streamlit as st
import base64
import time

st.set_page_config(page_title="Cabbase", page_icon="‚úàÔ∏è", layout="wide")

# CSS ƒë·ªÉ ·∫©n to√†n b·ªô ph·∫ßn UI Streamlit
st.markdown("""
<style>
#MainMenu, header, footer {visibility: hidden;}
.block-container {padding: 0 !important; margin: 0 !important;}
</style>
""", unsafe_allow_html=True)

# Ph√°t hi·ªán thi·∫øt b·ªã
user_agent = st.query_params.get("user_agent", [""])[0] or st.session_state.get("user_agent", "")
if not user_agent:
    import re
    user_agent = st.runtime.scriptrunner.get_script_run_ctx().request.headers.get("User-Agent", "")
st.session_state["user_agent"] = user_agent
is_mobile = "mobile" in user_agent.lower()

# Ch·ªçn file video v√† background
video_file = "mobile.mp4" if is_mobile else "airplane.mp4"
bg_image = "mobile.jpg" if is_mobile else "cabbase.jpg"

# Chuy·ªÉn trang ch√≠nh sau intro
if "page" not in st.session_state:
    st.session_state.page = "intro"

if st.session_state.page == "intro":
    with open(video_file, "rb") as v:
        vid_data = v.read()
    video_base64 = base64.b64encode(vid_data).decode()

    # ƒê·ªçc file √¢m thanh m√°y bay
    with open("plane_fly.mp3", "rb") as a:
        audio_data = a.read()
    audio_base64 = base64.b64encode(audio_data).decode()

    st.markdown(f"""
    <div style="
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        overflow: hidden; z-index: 1;
    ">
        <video id="introVideo" autoplay playsinline muted style="
            width: 100vw; height: 100vh; object-fit: cover;
        ">
            <source src="data:video/mp4;base64,{video_base64}" type="video/mp4">
        </video>
        <audio id="planeSound">
            <source src="data:audio/mp3;base64,{audio_base64}" type="audio/mp3">
        </audio>
        <div class="fade-text">KH√ÅM PH√Å TH·∫æ GI·ªöI C√ôNG CH√öNG T√îI</div>
    </div>

    <script>
    const vid = document.getElementById("introVideo");
    const audio = document.getElementById("planeSound");
    vid.volume = 1.0;
    audio.volume = 0.5;

    // Ph√°t ƒë·ªìng th·ªùi video v√† √¢m thanh
    vid.onplay = () => {{
        audio.play();
    }};

    // Hi·ªáu ·ª©ng ch·ªØ m·ªù d·∫ßn v√† √°nh s√°ng qu√©t ch·∫≠m su·ªët 5s
    const text = document.querySelector('.fade-text');
    text.animate([
        {{ opacity: 0, filter: 'brightness(1)' }},
        {{ opacity: 1, filter: 'brightness(2)' }},
        {{ opacity: 1, filter: 'brightness(1.5)' }},
        {{ opacity: 0, filter: 'brightness(1)' }}
    ], {{
        duration: 5000,
        easing: 'ease-in-out',
        iterations: 1
    }});

    // Sau 9s chuy·ªÉn trang
    setTimeout(() => {{
        window.parent.postMessage({{type: 'SWITCH_PAGE'}}, '*');
    }}, 9000);
    </script>

    <style>
    .fade-text {{
        position: absolute;
        top: 50%;
        width: 100%;
        text-align: center;
        font-family: 'Cinzel', serif;
        font-weight: 700;
        font-size: 4vw;
        color: white;
        text-shadow: 0 0 25px rgba(255,255,255,0.7);
        animation: glow 5s linear forwards;
    }}

    @keyframes glow {{
        0% {{ filter: brightness(0.6); }}
        50% {{ filter: brightness(2); }}
        100% {{ filter: brightness(1); opacity: 0; }}
    }}
    </style>
    """, unsafe_allow_html=True)

    # Khi nh·∫≠n t√≠n hi·ªáu t·ª´ JS, ƒë·ªïi sang trang ch√≠nh
    st.session_state.page = "main"

elif st.session_state.page == "main":
    st.markdown(f"""
    <style>
    body {{
        background: url("{bg_image}") no-repeat center center fixed;
        background-size: cover;
    }}
    audio {{
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
    }}
    </style>
    """, unsafe_allow_html=True)

    st.markdown("<h1 style='text-align:center; color:white;'>üåç Trang ch√≠nh Cabbase</h1>", unsafe_allow_html=True)
    st.audio("background.mp3")
