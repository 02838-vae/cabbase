import streamlit as st
import base64
import os
import time

# --- C·∫§U H√åNH BAN ƒê·∫¶U ---
st.set_page_config(page_title="T·ªï B·∫£o D∆∞·ª°ng S·ªë 1", layout="wide")

# T√™n c√°c file c·∫ßn thi·∫øt
video_file = "airplane.mp4"
bg_file = "cabbase.jpg"
audio_file = "background.mp3"

# ∆Ø·ªõc t√≠nh th·ªùi gian chuy·ªÉn c·∫£nh (C·∫ßn ƒëi·ªÅu ch·ªânh)
VIDEO_DURATION_SECONDS = 5  
FADE_DURATION_SECONDS = 4   
TOTAL_DELAY_SECONDS = VIDEO_DURATION_SECONDS + FADE_DURATION_SECONDS

# H√†m ƒë·ªçc file v√† chuy·ªÉn th√†nh Base64
def get_base64(file_path):
    try:
        with open(file_path, "rb") as f:
            return base64.b64encode(f.read()).decode("utf-8")
    except FileNotFoundError:
        return None

# Kh·ªüi t·∫°o Session State
if "show_main" not in st.session_state:
    st.session_state.show_main = False
if "intro_ran" not in st.session_state:
    st.session_state.intro_ran = False

# CSS ƒë·ªông ƒë·ªÉ ki·ªÉm so√°t hi·ªÉn th·ªã video (Ch·ªëng Flicker)
is_main_page = st.session_state.show_main
video_display_style = "display: none;" if is_main_page else "display: flex;" 

# === CSS N·ªÄN T·∫¢NG V√Ä FULLSCREEN/RESPONSIVE ===
st.markdown(f"""
<style>
/* 1. KH·∫ÆC PH·ª§C VIEWPORT CHO MOBILE (S·ª≠ d·ª•ng ƒë∆°n v·ªã 'vh' th∆∞·ªùng g·∫∑p l·ªói tr√™n mobile) */
/* C·ªë g·∫Øng s·ª≠a l·ªói 100vh kh√¥ng ch√≠nh x√°c tr√™n c√°c tr√¨nh duy·ªát mobile */
html, body {{ margin:0; padding:0; height:100%; overflow:hidden; background:black; }}

/* 2. FULLSCREEN TRI·ªÜT ƒê·ªÇ */
header[data-testid="stHeader"], footer {{ display: none !important; }}
section.main > div {{ padding-top: 0 !important; padding-left: 0 !important; padding-right: 0 !important; }}
.block-container, .stApp {{
    margin: 0 !important;
    padding: 0 !important;
    max-width: 100% !important;
    width: 100% !important; /* D√πng 100% thay v√¨ 100vw */
    min-height: 100vh !important;
    /* D√πng min-height 100vh ƒë·ªÉ ƒë·∫£m b·∫£o chi·ªÅu cao t·ªëi thi·ªÉu */
}}

/* 3. CSS CHO VIDEO CONTAINER (RESPONSIVE VIDEO V√Ä CH·ªêNG FLICKER) */
.video-container {{
    position: fixed; inset:0; width:100%; height:100%;
    justify-content:center; align-items:center;
    background:black; z-index:9999;
    {video_display_style} 
}}
.video-bg {{ 
    width:100%; 
    height:100%; 
    object-fit:cover; /* ƒê·∫£m b·∫£o video l·∫•p ƒë·∫ßy khung h√¨nh m√† kh√¥ng b·ªã m√©o */
}}

/* Hi·ªáu ·ª©ng m·ªù d·∫ßn */
@keyframes fadeOut {{ /* Gi·ªØ nguy√™n hi·ªáu ·ª©ng */
    0% {{opacity:1; visibility:visible;}}
    99% {{opacity:0.01; visibility:visible;}}
    100%{{opacity:0; visibility:hidden;}}
}}
.intro-animation {{
    animation: fadeOut {FADE_DURATION_SECONDS}s ease-out {VIDEO_DURATION_SECONDS}s forwards; 
}}

/* C√°c animation text gi·ªØ nguy√™n */
.video-text {{
    position:absolute; bottom:12vh; width:100%; text-align:center;
    font-family:'Special Elite', cursive; font-size:clamp(24px,5vw,44px);
    font-weight:bold; color:#fff;
    text-shadow: 0 0 20px rgba(255,255,255,0.8), 0 0 40px rgba(180,220,255,0.6), 0 0 60px rgba(255,255,255,0.4);
    opacity:0;
    animation: appear 3s ease-in forwards, floatFade 3s ease-in 5s forwards;
}}
@keyframes appear {{ 0% {{opacity:0; filter:blur(8px); transform:translateY(40px);}} 100%{{opacity:1; filter:blur(0); transform:translateY(0);}} }}
@keyframes floatFade {{ 0% {{opacity:1; filter:blur(0); transform:translateY(0);}} 100%{{opacity:0; filter:blur(12px); transform:translateY(-30px) scale(1.05);}} }}
</style>
""", unsafe_allow_html=True)


# --- GIAO DI·ªÜN CHUY·ªÇN C·∫¢NH (VIDEO INTRO) ---
if not st.session_state.show_main and not st.session_state.intro_ran:
    
    video_data = get_base64(video_file)
    if video_data is None:
        st.error(f"‚ùå Kh√¥ng t√¨m th·∫•y file {video_file}.")
        st.stop()
    
    # HTML/Video v√† K√≠ch ho·∫°t Rerun B·∫±ng Python
    st.markdown(f"""
    <div class="video-container intro-animation" id="videoContainer">
        <video id="introVideo" class="video-bg" autoplay muted playsinline>
            <source src="data:video/mp4;base64,{video_data}" type="video/mp4">
        </video>
        <div class="video-text">KH√ÅM PH√Å TH·∫æ GI·ªöI C√ôNG CH√öNG T√îI</div>
    </div>
    """, unsafe_allow_html=True)
    
    # T·∫°m d·ª´ng lu·ªìng Streamlit v√† k√≠ch ho·∫°t RERUN
    time.sleep(TOTAL_DELAY_SECONDS) 
    
    st.session_state.show_main = True
    st.session_state.intro_ran = True 
    st.rerun() 
    
    st.stop() 

# --- TRANG CH√çNH ---

img_base64 = get_base64(bg_file)
if img_base64 is None:
    st.error(f"‚ùå Kh√¥ng t√¨m th·∫•y file {bg_file}.")
    st.stop()

st.markdown(f"""
<style>
/* 4. CSS cho Trang Ch√≠nh (RESPONSIVE BACKGROUND) */
.stApp {{
    /* ƒê·∫£m b·∫£o background fill to√†n b·ªô m√†n h√¨nh */
    background: linear-gradient(rgba(245,242,200,0.4), rgba(245,242,200,0.4)),
                url("data:image/jpeg;base64,{img_base64}") no-repeat center center fixed;
    background-size: cover; /* <--- ƒê·∫£m b·∫£o background fit v√† l·∫•p ƒë·∫ßy khung h√¨nh */
}}
/* Kh√¥i ph·ª•c padding nh·∫π cho n·ªôi dung trang ch√≠nh */
.block-container {{ padding-top:2rem !important; padding-left:1rem !important; padding-right:1rem !important;}}

/* ƒê·∫£m b·∫£o header/footer ·∫©n khi ·ªü trang ch√≠nh */
header[data-testid="stHeader"] {{ display:none; }}
footer {{ display:none; }}

.main-title {{
    font-family:'Special Elite', cursive;
    font-size: clamp(36px,5vw,48px);
    font-weight:bold; text-align:center;
    color:#3e2723; margin-top:50px;
    text-shadow:2px 2px 0 #fff,0 0 25px #f0d49b,0 0 50px #bca27a;
}}
</style>
""", unsafe_allow_html=True)

# Nh·∫°c g√≥c tr√™n tr√°i
audio_base64 = get_base64(audio_file)
if audio_base64:
    st.markdown(f"""
    <audio autoplay loop controls style="position:fixed; top:10px; left:10px; width:200px; z-index:9999;">
        <source src="data:audio/mp3;base64,{audio_base64}" type="audio/mp3">
    </audio>
    """, unsafe_allow_html=True)

st.markdown('<div class="main-title">üìú T·ªî B·∫¢O D∆Ø·ª†NG S·ªê 1</div>', unsafe_allow_html=True)
st.write("Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi website ‚úàÔ∏è")
