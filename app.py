import streamlit as st
import base64

# --- H√ÄM H·ªñ TR·ª¢ ---
def get_base64_encoded_file(file_path):
    """M√£ h√≥a file th√†nh chu·ªói base64."""
    try:
        with open(file_path, "rb") as f:
            data = f.read()
        return base64.b64encode(data).decode("utf-8")
    except FileNotFoundError:
        # Tr·∫£ v·ªÅ chu·ªói r·ªóng n·∫øu kh√¥ng t√¨m th·∫•y file
        return "" 

# --- C·∫§U H√åNH V√Ä M√É H√ìA MEDIA ---

# C·∫•u h√¨nh trang (T·∫Øt menu m·∫∑c ƒë·ªãnh)
st.set_page_config(
    page_title="Kh√°m ph√° c√πng ch√∫ng t√¥i",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# M√£ h√≥a c√°c file media v√† h√¨nh n·ªÅn
try:
    video_pc_base64 = get_base64_encoded_file("airplane.mp4")
    video_mobile_base64 = get_base64_encoded_file("mobile.mp4")
    audio_base64 = get_base64_encoded_file("plane_fly.mp3")
    
    # M√£ h√≥a h√¨nh n·ªÅn ƒë·ªÉ nh√∫ng v√†o CSS (Quan tr·ªçng)
    cabbage_base64 = get_base64_encoded_file("cabbage.jpg")
    mobile_bg_base64 = get_base64_encoded_file("mobile.jpg")
    
    # Ki·ªÉm tra xem c√≥ ƒë·ªß file c·∫ßn thi·∫øt kh√¥ng
    if not (video_pc_base64 and video_mobile_base64 and audio_base64 and cabbage_base64 and mobile_bg_base64):
        missing_files = []
        if not video_pc_base64: missing_files.append("airplane.mp4")
        if not video_mobile_base64: missing_files.append("mobile.mp4")
        if not audio_base64: missing_files.append("plane_fly.mp3")
        if not cabbage_base64: missing_files.append("cabbage.jpg")
        if not mobile_bg_base64: missing_files.append("mobile.jpg")
        st.error(f"L·ªói: Kh√¥ng t√¨m th·∫•y (ho·∫∑c file r·ªóng) c√°c file sau: {', '.join(missing_files)}. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng d·∫´n.")
        st.stop()
        
except Exception as e:
    st.error(f"L·ªói h·ªá th·ªëng khi ƒë·ªçc file: {e}")
    st.stop()


# --- CSS CHUNG CHO STREAMLIT (NH√öNG ·∫¢NH N·ªÄN) ---

# S·ª¨A L·ªñI KEYERROR: S·ª≠ d·ª•ng placeholder {t√™n_bi·∫øn} ƒë·ªÉ format
hide_streamlit_style = f"""
<style>
/* ·∫®n c√°c th√†nh ph·∫ßn m·∫∑c ƒë·ªãnh c·ªßa Streamlit */
#MainMenu {{visibility: hidden;}}
footer {{visibility: hidden;}}
header {{visibility: hidden;}}

/* ƒê·∫£m b·∫£o Main Content Container chi·∫øm to√†n b·ªô kh√¥ng gian */
.main {{
    padding: 0;
    margin: 0;
    background-color: transparent; /* Quan tr·ªçng ƒë·ªÉ nh√¨n xuy√™n qua */
    transition: opacity 1s ease-in; /* Th√™m transition cho ƒë·ªô m∆∞·ª£t khi fade-in */
}}

/* ƒê·∫£m b·∫£o khu v·ª±c n·ªôi dung ƒë∆∞·ª£c cƒÉn ch·ªânh s√°t l·ªÅ */
div.block-container {{
    padding: 0;
    margin: 0;
    max-width: 100% !important;
}}

/* √âp iframe c·ªßa component chi·∫øm to√†n b·ªô chi·ªÅu cao/r·ªông */
iframe {{
    width: 100vw !important;
    height: 100vh !important;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000; /* ƒê·∫£m b·∫£o n√≥ che ph·ªß m·ªçi th·ª© */
}}

/* Class ƒë·ªÉ ·∫©n l·ªõp ph·ªß video sau khi chuy·ªÉn ti·∫øp */
.stApp.fade-out-overlay > iframe {{
    visibility: hidden; 
    opacity: 0;
    transition: visibility 0s 1.5s, opacity 1.5s ease-in-out; 
}}

/* Class ƒë·ªÉ l√†m hi·ªán n·ªôi dung ch√≠nh c·ªßa trang */
.stApp.fade-out-overlay .main {{
    opacity: 1; /* Hi·ªÉn th·ªã n·ªôi dung ch√≠nh */
}}

/* ·∫®n n·ªôi dung ch√≠nh ban ƒë·∫ßu */
.stApp .main {{
    opacity: 0;
}}


/* --- CSS CHO N·ªòI DUNG CH√çNH (N·ªÄN C·ªê ƒê·ªäNH) --- */
/* Th√™m n·ªÅn c·ªë ƒë·ªãnh cho to√†n b·ªô ·ª©ng d·ª•ng Streamlit */
.stApp {{
    /* ƒê·∫∑t n·ªÅn m·∫∑c ƒë·ªãnh cho PC */
    background-image: url('data:image/jpeg;base64,{cabbage_base64}') !important; 
    background-size: cover !important;
    background-position: center center !important;
    background-attachment: fixed !important; 
}}

@media (max-width: 768px) {{
    .stApp {{
        /* Thay th·∫ø n·ªÅn cho Mobile */
        background-image: url('data:image/jpeg;base64,{mobile_bg_base64}') !important;
    }}
}}

</style>
"""
# √Åp d·ª•ng CSS cho trang Streamlit ch√≠nh
st.markdown(hide_streamlit_style, unsafe_allow_html=True)


# --- M√É HTML/CSS/JavaScript CHO VIDEO INTRO (TRONG IFRAME) ---

html_content = f"""
<!DOCTYPE html>
<html>
<head>
    <style>
        /* CSS TRONG IFRAME */
        html, body {{
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw;
            background: black;
        }}
        
        /* CSS cho video fullscreen */
        #intro-video {{
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -100;
            /* Th√™m transition cho hi·ªáu ·ª©ng ph√≥ng to m∆∞·ª£t m√† */
            transition: transform 1.5s cubic-bezier(0.5, 0.0, 0.5, 1.0), opacity 1.5s ease-out;
        }}
        
        /* Class khi video k·∫øt th√∫c (Hi·ªáu ·ª©ng Codepen) */
        #intro-video.fadeout {{
            transform: scale(1.1); /* Ph√≥ng to 10% */
            opacity: 0; /* L√†m m·ªù */
        }}

        /* CSS cho d√≤ng ch·ªØ c·ªë ƒë·ªãnh (Gi·ªØ nguy√™n) */
        #intro-text {{
            position: fixed;
            top: 5vh; 
            width: 100%;
            text-align: center;
            color: white; 
            font-size: 3vw; 
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); 
            z-index: 100; 
            pointer-events: none;
            opacity: 0; 
            transition: opacity 1s; 
        }}
        
        @media (max-width: 768px) {{
            #intro-text {{
                font-size: 8vw;
            }}
        }}
        
    </style>
</head>
<body>

    <div id="intro-text">KH√ÅM PH√Å TH·∫æ GI·ªöI C√ôNG CH√öNG T√îI</div>
    
    <video id="intro-video" muted playsinline></video>
    
    <audio id="background-audio"></audio>

    <script>
        document.addEventListener("DOMContentLoaded", function() {{
            const video = document.getElementById('intro-video');
            const audio = document.getElementById('background-audio');
            const introText = document.getElementById('intro-text');
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {{
                video.src = 'data:video/mp4;base64,{video_mobile_base64}';
            }} else {{
                video.src = 'data:video/mp4;base64,{video_pc_base64}';
            }}
            
            audio.src = 'data:audio/mp3;base64,{audio_base64}';

            const playMedia = () => {{
                video.load();
                video.play().catch(e => console.log("Video playback failed:", e));
                
                setTimeout(() => {{ introText.style.opacity = 1; }}, 500);

                audio.volume = 0.5; 
                audio.play().catch(e => {{
                    // Y√™u c·∫ßu t∆∞∆°ng t√°c c·ªßa ng∆∞·ªùi d√πng ƒë·ªÉ b·∫≠t audio tr√™n tr√¨nh duy·ªát
                    document.body.addEventListener('click', () => {{
                        audio.play().catch(err => console.error("Audio playback error on click:", err));
                    }}, {{ once: true }});
                }});
            }};
            
            playMedia();

            // --- LOGIC CHUY·ªÇN TRANG KHI VIDEO K·∫æT TH√öC ---
            video.onended = () => {{
                // 1. √Åp d·ª•ng hi·ªáu ·ª©ng ph√≥ng to/m·ªù cho video
                video.classList.add('fadeout');
                
                // 2. T·∫Øt nh·∫°c
                audio.pause(); 
                audio.currentTime = 0; 
                introText.style.opacity = 0;
                
                // 3. K√≠ch ho·∫°t chuy·ªÉn trang ch√≠nh (G·ª≠i l·ªánh cho Streamlit parent window)
                parent.document.querySelector('.stApp').classList.add('fade-out-overlay');
            }};
        }});
    </script>
</body>
</html>
"""

# Hi·ªÉn th·ªã th√†nh ph·∫ßn HTML (D√πng chi·ªÅu cao t·ªëi thi·ªÉu ƒë·ªÉ component t·ªìn t·∫°i)
st.components.v1.html(html_content, height=10, scrolling=False)


# --- N·ªòI DUNG CH√çNH C·ª¶A TRANG ---

# D√πng margin-top: 100vh ƒë·ªÉ n·ªôi dung n√†y n·∫±m d∆∞·ªõi l·ªõp video overlay ban ƒë·∫ßu
st.markdown("""
<div style="
    padding: 20px; 
    margin-top: 100vh; 
    background-color: rgba(255, 255, 255, 0.8); /* N·ªÅn h∆°i trong su·ªët ƒë·ªÉ nh√¨n th·∫•y ·∫£nh n·ªÅn c·ªë ƒë·ªãnh */
    position: relative; 
    z-index: 10;
    min-height: 100vh;
">
    <h1 style="color: black;">üëã Ch√†o m·ª´ng ƒë·∫øn v·ªõi Trang Ch√≠nh!</h1>
    <p style="color: black;">Hi·ªáu ·ª©ng chuy·ªÉn trang m∆∞·ª£t m√† ƒë√£ ho√†n t·∫•t.</p>
    <p style="color: black;">H√¨nh n·ªÅn (cabbage.jpg / mobile.jpg) ƒë∆∞·ª£c c·ªë ƒë·ªãnh v√† trang n√†y c√≥ th·ªÉ cu·ªôn ƒë∆∞·ª£c.</p>
    
    <div style="
        margin: 50px 0;
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        height: 800px; /* N·ªôi dung gi·∫£ ƒë·ªÉ t·∫°o thanh cu·ªôn */
        display: flex;
        align-items: center;
        justify-content: center;
    ">
        <h3 style="color: black;">Cu·ªôn xu·ªëng ƒë·ªÉ xem th√™m</h3>
    </div>
    
    <p style="color: black; text-align: center;">--- H·∫æT N·ªòI DUNG ---</p>
</div>
""", unsafe_allow_html=True)
