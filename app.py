import streamlit as st
import random
import time

# --- C·∫•u h√¨nh Trang (Lu√¥n ƒë·∫∑t ·ªü ƒë·∫ßu) ---
st.set_page_config(layout="wide", page_title="T·ªï B·∫£o D∆∞·ª°ng S·ªë 1")

# --- Kh·ªüi t·∫°o Session State ---
# 'intro_complete' l√† c·ªù ƒë·ªÉ ki·ªÉm tra xem Intro ƒë√£ ch·∫°y ch∆∞a
if 'intro_complete' not in st.session_state:
    st.session_state['intro_complete'] = False

# --- CSS T√πy ch·ªânh (ƒê·ªãnh nghƒ©a Phong c√°ch Vintage v√† Hi·ªáu ·ª©ng) ---
def local_css(file_name):
    """H√†m nh√∫ng CSS t·ª´ file ho·∫∑c chu·ªói"""
    with open(file_name) as f:
        st.markdown(f'<style>{f.read()}</style>', unsafe_allow_html=True)

def custom_css():
    """CSS nh√∫ng tr·ª±c ti·∫øp"""
    # L·∫•y t√™n file ·∫£nh n·ªÅn d·ª±a v√†o thi·∫øt b·ªã (Streamlit kh√¥ng c√≥ h√†m ki·ªÉm tra tr·ª±c ti·∫øp)
    # T·∫°m th·ªùi ta ch·ªâ d√πng 1 ·∫£nh n·ªÅn ho·∫∑c c·∫ßn JS ƒë·ªÉ check. D√πng 'cabbage.jpg' l√†m m·∫∑c ƒë·ªãnh.
    # Trong th·ª±c t·∫ø, b·∫°n c·∫ßn JS ƒë·ªÉ check viewport width v√† nh√∫ng CSS t∆∞∆°ng ·ª©ng.
    # D∆∞·ªõi ƒë√¢y l√† phong c√°ch vintage c∆° b·∫£n:
    
    # CSS cho n·ªÅn v√† font ch·ªØ Vintage
    vintage_css = f"""
    <style>
    /* ·∫®n thanh cu·ªôn m·∫∑c ƒë·ªãnh c·ªßa Streamlit v√† l√†m cho n·ªÅn ·∫£nh bao ph·ªß */
    .stApp {{
        background-image: url("cabbage.jpg"); /* ·∫¢nh n·ªÅn PC/Default */
        background-size: cover;
        background-attachment: fixed; /* Gi·ªØ ·∫£nh n·ªÅn c·ªë ƒë·ªãnh khi cu·ªôn */
        background-position: center;
    }}
    
    /* Thi·∫øt l·∫≠p font ch·ªØ ki·ªÉu c·ªï ƒëi·ªÉn (C·∫ßn c√†i ƒë·∫∑t font n·∫øu mu·ªën ch√≠nh x√°c) */
    h1, h2, h3, h4, .stText, p, .stMarkdown, label {{
        font-family: 'Times New Roman', serif; /* Font c·ªï ƒëi·ªÉn */
        color: #5D4037; /* M√†u n√¢u ƒë·∫≠m, c·ªï k√≠nh */
    }}
    
    /* M√†u n·ªÅn cho c√°c khung/widget ƒë·ªÉ tƒÉng t√≠nh c·ªï ƒëi·ªÉn */
    .stMarkdown, .stText, .stButton > button, .stAudio {{
        background-color: rgba(255, 255, 240, 0.7); /* M√†u tr·∫Øng ng√† m·ªù */
        border-radius: 5px;
        padding: 10px;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3); /* T·∫°o b√≥ng nh·∫π */
    }}
    
    /* Hi·ªáu ·ª©ng ch·ªØ Intro */
    @keyframes fade_in_out {{
        0% {{ opacity: 0; }}
        25% {{ opacity: 1; }}
        75% {{ opacity: 1; }}
        100% {{ opacity: 0; }}
    }}
    
    .intro_text {{
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3em;
        color: white;
        text-shadow: 2px 2px 4px #000000;
        animation: fade_in_out 4s forwards; /* 4s ƒë·ªÉ kh·ªõp v·ªõi video 5s (1s cu·ªëi m·ªù) */
        z-index: 1000;
        pointer-events: none;
    }}
    
    /* CSS cho hi·ªáu ·ª©ng m·ªù d·∫ßn */
    @keyframes fade_out {{
        0% {{ opacity: 1; }}
        100% {{ opacity: 0; }}
    }}
    
    .video_fade_out {{
        animation: fade_out 1s forwards; /* 1s ƒë·ªÉ m·ªù d·∫ßn */
        animation-delay: 4s; /* Ch·ªù 4s tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu m·ªù (Video 5s) */
    }}
    </style>
    """
    st.markdown(vintage_css, unsafe_allow_html=True)

# --- ƒê·ªãnh nghƒ©a c√°c M√†n h√¨nh ---

def intro_screen():
    """M√†n h√¨nh Intro v·ªõi Video v√† Ch·ªØ"""
    st.empty() # X√≥a h·∫øt n·ªôi dung tr∆∞·ªõc
    
    # √Åp d·ª•ng CSS m·ªù d·∫ßn cho Video
    video_html = """
    <div class="video_fade_out" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; background-color: black;">
        <video width="100%" height="100%" autoplay muted playsinline style="object-fit: cover;">
            <source src="airplane.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    <div class="intro_text">KH√ÅM PH√Å TH·∫æ GI·ªöI C√ôNG CH√öNG T√îI</div>
    """
    st.markdown(video_html, unsafe_allow_html=True)

    # ƒê·∫∑t h·∫πn gi·ªù ƒë·ªÉ chuy·ªÉn tr·∫°ng th√°i sau 5 gi√¢y (Th·ªùi l∆∞·ª£ng video)
    # Streamlit kh√¥ng ch·∫°y background thread, n√™n ta d√πng JS/HTML ƒë·ªÉ check time th·ª±c t·∫ø.
    # Trong m√¥i tr∆∞·ªùng Streamlit, ta d√πng `time.sleep` ho·∫∑c m·ªôt trick nh·ªè:
    
    # --- TRICK Streamlit ƒë·ªÉ chuy·ªÉn tr·∫°ng th√°i sau time.sleep ---
    # Ta d√πng m·ªôt placeholder v√† ƒë·ª£i, sau ƒë√≥ c·∫≠p nh·∫≠t session state.
    # L∆∞u √Ω: ƒêi·ªÅu n√†y s·∫Ω l√†m ·ª©ng d·ª•ng "ƒë·ª©ng" 5s. N·∫øu b·∫°n mu·ªën tr·∫£i nghi·ªám m∆∞·ª£t h∆°n, 
    # c·∫ßn d√πng JavaScript ƒë·ªÉ th√¥ng b√°o khi video k·∫øt th√∫c.
    
    if not st.session_state.get('intro_ran'):
        with st.empty():
            time.sleep(5) # ƒê·ª£i 5 gi√¢y
            st.session_state['intro_complete'] = True
            st.session_state['intro_ran'] = True
            st.rerun() # T·∫£i l·∫°i trang ƒë·ªÉ chuy·ªÉn sang Trang ch√≠nh

def main_page():
    """Trang Ch√≠nh theo phong c√°ch Vintage"""
    custom_css() # √Åp d·ª•ng CSS Vintage cho Trang Ch√≠nh

    # 1. Thanh ph√°t nh·∫°c ng·∫´u nhi√™n (G√≥c tr√™n b√™n tr√°i)
    music_files = ["background.mp3", "background1.mp3", "background2.mp3", "background3.mp3", "background4.mp3", "background5.mp3"]
    # Ch·ªçn ng·∫´u nhi√™n m·ªôt b√†i ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√°t
    random_track = random.choice(music_files)
    
    # S·ª≠ d·ª•ng st.sidebar ƒë·ªÉ ƒë·∫∑t thanh nh·∫°c g√≥c tr√™n b√™n tr√°i
    with st.sidebar:
        st.subheader("üé∂ Nh·∫°c N·ªÅn C·ªï ƒêi·ªÉn")
        # D√πng st.audio ƒë·ªÉ ph√°t nh·∫°c
        st.audio(random_track, format="audio/mp3", start_time=0)
        st.caption(f"ƒêang ph√°t: **{random_track}**")
        st.markdown(
            """
            <style>
            /* ƒê·ªãnh d·∫°ng l·∫°i st.audio trong sidebar cho phong c√°ch Vintage */
            .stAudio {{
                background-color: rgba(245, 245, 220, 0.8); /* M√†u be nh·∫°t */
                border: 1px solid #A1887F; /* Vi·ªÅn n√¢u c·ªï */
                border-radius: 10px;
                padding: 5px;
            }}
            </style>
            """, unsafe_allow_html=True
        )

    # 2. Ti√™u ƒë·ªÅ canh gi·ªØa
    st.markdown("<h1 style='text-align: center; color: #4E342E; font-size: 3.5em; text-shadow: 1px 1px 2px #FFF8DC;'>T·ªî B·∫¢O D∆Ø·ª†NG S·ªê 1</h1>", unsafe_allow_html=True)
    
    st.write("---")

    # 3. N·ªôi dung trang ch√≠nh (Vintage Content)
    col1, col2 = st.columns([1, 2])
    
    with col1:
        st.markdown(
            """
            <div style="border: 2px solid #A1887F; padding: 15px; border-radius: 5px; background-color: rgba(255, 255, 240, 0.8);">
                <h2 style='color: #6D4C41;'>üìú Ch√¢m Ng√¥n Ph·ª•c H∆∞ng</h2>
                <p>
                *M·ªói c·ªó m√°y l√† m·ªôt c√¢u chuy·ªán c·∫ßn ƒë∆∞·ª£c g√¨n gi·ªØ. Ch√∫ng t√¥i kh√¥ng ch·ªâ s·ª≠a ch·ªØa, ch√∫ng t√¥i h·ªìi sinh K√Ω ·ª©c.*
                </p>
                <p>
                Th·ªùi ƒë·∫°i kh√¥ng th·ªÉ x√≥a nh√≤a ƒëi gi√° tr·ªã c·ªßa s·ª± Tinh X·∫£o. H√£y ƒë·ªÉ nh·ªØng c·ªï v·∫≠t c·ªßa b·∫°n l·∫°i T·ªèa S√°ng!
                </p>
            </div>
            """, unsafe_allow_html=True
        )

    with col2:
        st.markdown(
            """
            <div style="border: 2px solid #A1887F; padding: 15px; border-radius: 5px; background-color: rgba(255, 255, 240, 0.8);">
                <h2 style='color: #6D4C41;'>‚öôÔ∏è D·ªãch V·ª• C·ªßa Ch√∫ng T√¥i</h2>
                <ul>
                    <li>Ph·ª•c h·ªìi ƒë·ªìng h·ªì c·ªï v√† m√°y ƒë√°nh ch·ªØ.</li>
                    <li>B·∫£o d∆∞·ª°ng xe ƒë·∫°p, xe m√°y c·ªï.</li>
                    <li>S·ª≠a ch·ªØa c√°c thi·∫øt b·ªã c∆° kh√≠ th·ªß c√¥ng.</li>
                </ul>
                <p style="text-align: right; font-style: italic;">Li√™n h·ªá: 1800-VINTAGE</p>
            </div>
            """, unsafe_allow_html=True
        )
    
    # Gi·∫£ l·∫≠p th√™m m·ªôt s·ªë n·ªôi dung n·ªØa
    st.write("\n")
    st.subheader("B·ªô S∆∞u T·∫≠p Ti√™u Bi·ªÉu")
    st.image("cabbage.jpg", caption="H√¨nh ·∫£nh ch·ªâ mang t√≠nh minh h·ªça cho phong c√°ch c·ªï ƒëi·ªÉn", width=400)


# --- Lu·ªìng ·ª®ng D·ª•ng Ch√≠nh ---
if st.session_state['intro_complete']:
    main_page()
else:
    intro_screen()
